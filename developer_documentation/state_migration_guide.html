<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State migration guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basic_usage.html"><strong aria-hidden="true">1.1.</strong> Basic Usage</a></li><li class="chapter-item expanded "><a href="../cli.html"><strong aria-hidden="true">1.2.</strong> Command-line interface</a></li><li class="chapter-item expanded "><a href="../configuration.html"><strong aria-hidden="true">1.3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../docker.html"><strong aria-hidden="true">1.4.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../js_console.html"><strong aria-hidden="true">1.5.</strong> JavaScript Console</a></li><li class="chapter-item expanded "><a href="../trouble_shooting.html"><strong aria-hidden="true">1.6.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">1.7.</strong> Glossary</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Developer documentation</li><li class="chapter-item expanded "><a href="../developer_documentation/introduction.html"><strong aria-hidden="true">2.</strong> Developer documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../developer_documentation/application_architecture.html"><strong aria-hidden="true">2.1.</strong> Application architecture</a></li><li class="chapter-item expanded "><a href="../developer_documentation/contributing.html"><strong aria-hidden="true">2.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../developer_documentation/local_actions.html"><strong aria-hidden="true">2.3.</strong> Local GH Actions</a></li><li class="chapter-item expanded "><a href="../developer_documentation/mainnet_compatibility.html"><strong aria-hidden="true">2.4.</strong> Mainnet compatibility</a></li><li class="chapter-item expanded "><a href="../developer_documentation/memory-analysis.html"><strong aria-hidden="true">2.5.</strong> Memory analysis</a></li><li class="chapter-item expanded "><a href="../developer_documentation/release_checklist.html"><strong aria-hidden="true">2.6.</strong> Release checklist</a></li><li class="chapter-item expanded "><a href="../developer_documentation/smoke_testing.html"><strong aria-hidden="true">2.7.</strong> Smoke testing</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration.html"><strong aria-hidden="true">2.8.</strong> State migration</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration_guide.html" class="active"><strong aria-hidden="true">2.9.</strong> State migration guide</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration_spike.html"><strong aria-hidden="true">2.10.</strong> State migration spike NV17-NV18</a></li><li class="chapter-item expanded "><a href="../developer_documentation/test_plan.html"><strong aria-hidden="true">2.11.</strong> Test plan</a></li><li class="chapter-item expanded "><a href="../developer_documentation/devnet_notes.html"><strong aria-hidden="true">2.12.</strong> Devnet Notes</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="state-migration-guide-"><a class="header" href="#state-migration-guide-">State migration guide ⏩</a></h2>
<p>This guide is intended to help to implement new state migration in the future.
It will be based on the current state migration implementation for NV18 and
NV19.</p>
<h3 id="state-migration-requirements"><a class="header" href="#state-migration-requirements">State migration requirements</a></h3>
<ul>
<li>The proper actor bundle is released for at least the test network. It should
be available on the
<a href="https://github.com/filecoin-project/builtin-actors/releases">actor bundles repository</a>.
You can verify which upgrade needs which bundle in the
<a href="https://github.com/filecoin-project/core-devs/tree/master/Network%20Upgrades">network upgrade matrix</a>.</li>
<li>The state migration should be implemented in the
<a href="https://github.com/filecoin-project/go-state-types/tree/master/builtin">Go library</a>.
This is the source of truth for the state migration. Also, we should carefully
analyze the FIPs and implement the migration based on them. In case of doubt,
we should always consider the FIPs as the source of truth and reach out to the
Lotus team if we find potential issues in their implementation.</li>
</ul>
<h3 id="development"><a class="header" href="#development">Development</a></h3>
<h4 id="import-the-actor-bundle"><a class="header" href="#import-the-actor-bundle">Import the actor bundle</a></h4>
<p>The first step is to import the actor bundle into Forest. This is done by:</p>
<ul>
<li>adding the bundle to the <code>HeightInfos</code> struct in the network definitions files
(e.g.,
<a href="https://github.com/ChainSafe/forest/blob/main/networks/src/calibnet/mod.rs">calibnet</a>).</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>HeightInfo {
    height: Height::Hygge,
    epoch: 322_354,
    bundle: Some(ActorBundleInfo {
        manifest: Cid::try_from(&quot;bafy2bzaced25ta3j6ygs34roprilbtb3f6mxifyfnm7z7ndquaruxzdq3y7lo&quot;).unwrap(),
        url: Url::parse(&quot;https://github.com/filecoin-project/builtin-actors/releases/download/v10.0.0-rc.1/builtin-actors-calibrationnet.car&quot;).unwrap()
})
<span class="boring">}</span></code></pre></pre>
<ul>
<li>Adding the download at the proper height to the <code>load_bundles</code> function in the
<a href="https://github.com/ChainSafe/forest/blob/main/forest/daemon/src/bundle/mod.rs">daemon</a>.
This step could be potentially done automatically in the future.</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if epoch &lt; config.chain.epoch(Height::Hygge) {
    bundles.push(get_actors_bundle(config, Height::Hygge).await?);
}
<span class="boring">}</span></code></pre></pre>
<h3 id="implement-the-migration"><a class="header" href="#implement-the-migration">Implement the migration</a></h3>
<p>The next step is to implement the migration itself. In this guide, we will take
the <code>translate Go code into Rust</code> approach. It's not the cleanest way to do it,
but it's the easiest. Note that the Forest state migration design is not the
same as the Lotus one (we tend to avoid code duplications), so we must be
careful when translating the code.</p>
<h4 id="create-the-migration-module"><a class="header" href="#create-the-migration-module">Create the migration module</a></h4>
<p>Create the migration module in the
<a href="https://github.com/ChainSafe/forest/tree/main/vm/state_migration/src">state migration crate</a>.
A valid approach is just to copy-paste the previous migration module and modify
it accordingly. The files that will most likely be present:</p>
<ul>
<li><code>mod.rs</code>: here we bundle our migration modules and export the final migration
function,</li>
<li><code>system.rs</code>: here we define the system actor migration logic which (so far)
seems to not change between upgrades,</li>
<li><code>migration.rs</code>: the heart of the migration. Here we add the migration logic
for each actor. Its Go equivalent is the
<a href="https://github.com/filecoin-project/go-state-types/blob/master/builtin/v10/migration/top.go">top.go</a>,
in case of NV18,</li>
<li><code>verifier.rs</code>: checks for the migration definition.</li>
</ul>
<p>We will most likely need as many custom migrators as there are in the Go
implementation. In other terms, if you see that the Go
<a href="https://github.com/filecoin-project/go-state-types/tree/master/builtin/v10/migration">migration</a>
contains:</p>
<ul>
<li><code>eam.go</code> - Ethereum Account Manager migration,</li>
<li><code>init.go</code> - Init actor migration,</li>
<li><code>system.go</code> - System actor migration,</li>
</ul>
<p>Then our implementation will need to define those as well.</p>
<h4 id="the-actual-migration"><a class="header" href="#the-actual-migration">The actual migration</a></h4>
<p>This part will largely depend on the complexity of the network upgrade itself.
The goal is to translate the <code>MigrateStateTree</code> method from
<a href="https://github.com/filecoin-project/go-state-types/blob/master/builtin/v10/migration/top.go#L28">Go</a>
to the <code>add_nvXX_migrations</code> in the <code>migration.rs</code> file. The
<code>add_nvXX_migrations</code> method is responsible for adding all the migrations that
are needed for the network upgrade and the logic in between. Note that the
Forest version is much simpler as it doesn't contain the migration <code>engine</code>
(implemented in the base module).</p>
<p>The first thing to do is to get the current system actor state and the current
manifest. Then we will map the old actor codes to the new ones.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let state_tree = StateTree::new_from_root(store.clone(), state)?;
let system_actor = state_tree
    .get_actor(&amp;Address::new_id(0))?
    .ok_or_else(|| anyhow!(&quot;system actor not found&quot;))?;

let system_actor_state = store
    .get_obj::&lt;SystemStateV10&gt;(&amp;system_actor.state)?
    .ok_or_else(|| anyhow!(&quot;system actor state not found&quot;))?;
let current_manifest_data = system_actor_state.builtin_actors;
let current_manifest = Manifest::load(&amp;store, &amp;current_manifest_data, 1)?;

let (version, new_manifest_data): (u32, Cid) = store
    .get_cbor(new_manifest)?
    .ok_or_else(|| anyhow!(&quot;new manifest not found&quot;))?;
let new_manifest = Manifest::load(&amp;store, &amp;new_manifest_data, version)?;

<span class="boring">}</span></code></pre></pre>
<p>⚠️ Stay vigilant! The <code>StateTree</code> versioning is independent of the network and
actor versioning. At the time of writing, the following holds:</p>
<ul>
<li><code>StateTreeVersion0</code> - Actors version &lt; v2</li>
<li><code>StateTreeVersion1</code> - Actors version v2</li>
<li><code>StateTreeVersion2</code> - Actors version v3</li>
<li><code>StateTreeVersion3</code> - Actors version v4</li>
<li><code>StateTreeVersion4</code> - Actors version v5 up to v9</li>
<li><code>StateTreeVersion5</code> - Actors version v10 and above These are not compatible
with each other and when using a new FVM, we can only use the latest one.</li>
</ul>
<p>For actors that don't need any state migration, we can use the <code>nil_migrator</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>current_manifest.builtin_actor_codes().for_each(|code| {
let id = current_manifest.id_by_code(code);
let new_code = new_manifest.code_by_id(id).unwrap();
self.add_migrator(*code, nil_migrator(*new_code));
});

For each actor with non-trivial migration logic, we add the migration function. For example, for the `init` actor, we have:
```rust
self.add_migrator(
*current_manifest.get_init_code(),
init::init_migrator(*new_manifest.get_init_code()),
);
<span class="boring">}</span></code></pre></pre>
<p>and we define the <code>init_migrator</code> in a separate module. This logic may include
setting some defaults on the new fields, changing the current ones to an
upgraded version and so on.</p>
<h4 id="verifier"><a class="header" href="#verifier">Verifier</a></h4>
<p>An optional (but recommended) piece of code that performs some sanity checks on
the state migration definition. At the time of writing, it checks that all
builtin actors are assigned a migration function.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let verifier = Arc::new(Verifier::default());
<span class="boring">}</span></code></pre></pre>
<h4 id="post-migration-actions"><a class="header" href="#post-migration-actions">Post-migration actions</a></h4>
<p>Some code, like creating an entirely new actor (in the case of NV18 creating EAM
and Ethereum Account actors), needs to be executed post-migration. This is done
in the post-migration actions.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let post_migration_actions = [create_eam_actor, create_eth_account_actor]
    .into_iter()
    .map(|action| Arc::new(action) as PostMigrationAction&lt;DB&gt;)
    .collect();
<span class="boring">}</span></code></pre></pre>
<h4 id="creating-the-migration-object-and-running-it"><a class="header" href="#creating-the-migration-object-and-running-it">Creating the migration object and running it</a></h4>
<p>We take all the migrations that we have defined previously, all the
post-migration actions, and create the migration object.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut migration = StateMigration::&lt;DB&gt;::new(Some(verifier), post_migration_actions);
migration.add_nv18_migrations(blockstore.clone(), state, &amp;new_manifest_cid)?;

let actors_in = StateTree::new_from_root(blockstore.clone(), state)?;
let actors_out = StateTree::new(blockstore.clone(), StateTreeVersion::V5)?;
let new_state =
migration.migrate_state_tree(blockstore.clone(), epoch, actors_in, actors_out)?;

Ok(new_state)
<span class="boring">}</span></code></pre></pre>
<p>The new state is the result of the migration.</p>
<h3 id="use-the-migration"><a class="header" href="#use-the-migration">Use the migration</a></h3>
<p>After completing the migration, we need to invoke it at the proper height. This
is done in the <code>handle_state_migrations</code> method in the
<a href="https://github.com/ChainSafe/forest/blob/main/blockchain/state_manager/src/lib.rs">state manager</a>.
This step could be potentially done automatically in the future.</p>
<h3 id="testing"><a class="header" href="#testing">Testing</a></h3>
<p>We currently lack a framework for properly testing the network upgrades before
they actually happen. This should change in the future.</p>
<p>For now, we can do it using a snapshot generated after the network upgrade,
e.g., 100 epochs after and validating previous epochs which should include the
upgrade height.</p>
<pre><code class="language-shell">forest --chain calibnet --encrypt-keystore false --halt-after-import --height=-200 --import-snapshot &lt;SNAPSHOT&gt;
</code></pre>
<h3 id="future-considerations"><a class="header" href="#future-considerations">Future considerations</a></h3>
<ul>
<li>Testing without the need for a snapshot or a running node. This would allow us
to test the network upgrade in a more isolated way. See how it is done in the
<a href="https://github.com/filecoin-project/go-state-types/blob/master/builtin/v9/migration/test/migration_test.go">Go library</a>.</li>
<li>Grab the actor bundles from the IPFS. This would make Forest less dependent on
the Github infrastructure.
<a href="https://github.com/ChainSafe/forest/issues/2765">Issue #2765</a></li>
<li>Consider pre-migrations as Lotus does. It is not needed at the moment (the
mainnet upgrade takes several seconds at most) but may become a bottleneck if
the migration is too heavy.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../developer_documentation/state_migration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../developer_documentation/state_migration_spike.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../developer_documentation/state_migration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../developer_documentation/state_migration_spike.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
