<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Transforms a given module into one that charges gas for code to be executed by proxy of an imported gas metering function."><title>inject in fvm_wasm_instrument::gas_metering - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-cb6f1f67f1bcd037.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="fvm_wasm_instrument" data-themes="" data-resource-suffix="" data-rustdoc-version="1.73.0 (cc66ad468 2023-10-03)" data-channel="1.73.0" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-1596385f77d47ef2.css" data-theme-dark-css="dark-0a43001d3fc2282c.css" data-theme-ayu-css="ayu-fd19013d6ce078bf.css" ><script src="../../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../static.files/light-1596385f77d47ef2.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../static.files/dark-0a43001d3fc2282c.css"><link rel="stylesheet" href="../../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../fvm_wasm_instrument/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../fvm_wasm_instrument/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><div class="sidebar-elems"><h2><a href="index.html">In fvm_wasm_instrument::gas_metering</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Function <a href="../index.html">fvm_wasm_instrument</a>::<wbr><a href="index.html">gas_metering</a>::<wbr><a class="fn" href="#">inject</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../src/fvm_wasm_instrument/gas_metering/mod.rs.html#537-733">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>pub fn inject&lt;R: <a class="trait" href="trait.Rules.html" title="trait fvm_wasm_instrument::gas_metering::Rules">Rules</a>&gt;(
    raw_wasm: &amp;[<a class="primitive" href="https://doc.rust-lang.org/1.73.0/std/primitive.u8.html">u8</a>],
    rules: <a class="primitive" href="https://doc.rust-lang.org/1.73.0/std/primitive.reference.html">&amp;R</a>,
    gas_module_name: &amp;<a class="primitive" href="https://doc.rust-lang.org/1.73.0/std/primitive.str.html">str</a>
) -&gt; <a class="type" href="../../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.73.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.73.0/std/primitive.u8.html">u8</a>&gt;&gt;</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Transforms a given module into one that charges gas for code to be executed by proxy of an
imported gas metering function.</p>
<p>The output module imports a mutable global i64 $GAS_COUNTER_NAME (“gas_couner”) from the
specified module. The value specifies the amount of available units of gas. A new function
doing gas accounting using this global is added to the module. Having the accounting logic
in WASM lets us avoid the overhead of external calls.</p>
<p>The body of each function is divided into metered blocks, and the calls to charge gas are
inserted at the beginning of every such block of code. A metered block is defined so that,
unless there is a trap, either all of the instructions are executed or none are. These are
similar to basic blocks in a control flow graph, except that in some cases multiple basic
blocks can be merged into a single metered block. This is the case if any path through the
control flow graph containing one basic block also contains another.</p>
<p>Charging gas is at the beginning of each metered block ensures that 1) all instructions
executed are already paid for, 2) instructions that will not be executed are not charged for
unless execution traps, and 3) the number of calls to “gas” is minimized. The corollary is that
modules instrumented with this metering code may charge gas for instructions not executed in
the event of a trap.</p>
<p>Additionally, each <code>memory.grow</code> instruction found in the module is instrumented to first make
a call to charge gas for the additional pages requested. This cannot be done as part of the
block level gas charges as the gas cost is not static and depends on the stack argument to
<code>memory.grow</code>.</p>
<p>The above transformations are performed for every function body defined in the module. This
function also rewrites all function indices references by code, table elements, etc., since
the addition of an imported functions changes the indices of module-defined functions.</p>
<p>This routine runs in time linear in the size of the input module.</p>
<p>The function fails if the module contains any operation forbidden by gas rule set, returning
the original module as an Err. Only one imported global is allowed per <code>gas_module_name</code>, the
one corresponding to the gas spending measurement</p>
</div></details></section></div></main></body></html>